{% extends "base.html" %}

{% block content %}
<div class="col-md-3 col-lg-2 sidebar p-3 d-none d-md-block" style="background-color: #0E1117; height: 100vh; border-right: 1px solid #2d3748;">
    <div class="d-flex align-items-center mb-4">
        <span class="fs-4">üõ°Ô∏è</span>
        <h5 class="mb-0 ms-2 fw-bold">Founder's Vault</h5>
    </div>

    <div class="mb-4 fade-in-delay-1">
        <small class="text-muted text-uppercase" style="font-size: 0.7rem; letter-spacing: 1px;">System Control</small>
        <div class="mt-2">
            <label class="form-label small">AI Engine</label>
            <select id="model-select" class="form-select form-select-sm bg-dark text-light border-secondary" disabled>
                {% for key, info in models.items() %}
                <option value="{{ key }}" {% if key == selected_model %}selected{% endif %}>{{ info.name }}</option>
                {% endfor %}
            </select>
            {% if models[selected_model].mode == 'performance' %}
            <div class="badge bg-info bg-opacity-10 text-info border border-info mt-2 w-100 py-2">
                üöÄ High Performance
            </div>
            {% else %}
            <div class="badge bg-success bg-opacity-10 text-success border border-success mt-2 w-100 py-2">
                üü¢ Speed Mode
            </div>
            {% endif %}
        </div>
    </div>

    <div class="mb-4 fade-in-delay-2">
        <small class="text-muted text-uppercase" style="font-size: 0.7rem; letter-spacing: 1px;">Current Document</small>
        <div class="mt-2 p-3 rounded bg-dark border border-secondary">
            <div class="d-flex align-items-center mb-1">
                <span class="me-2">üìÑ</span>
                <span class="d-block text-truncate fw-bold">{{ current_file.name }}</span>
            </div>
            <small class="text-muted text-uppercase" style="font-size: 0.7rem;">{{ current_file.type }} Format</small>
        </div>
    </div>

    <div class="mt-auto fade-in-delay-3">
        <form action="{{ url_for('main.clear_session') }}" method="post" class="d-grid gap-2">
            <button type="submit" class="btn btn-outline-warning btn-sm">Clear Chat Memory</button>
            <a href="{{ url_for('main.new_session') }}" class="btn btn-outline-danger btn-sm">New Session</a>
        </form>
    </div>
</div>

<div class="col-md-9 col-lg-10 p-0 d-flex flex-column position-relative" style="height: 100vh; background-color: #0E1117;">

    <div id="processing-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center z-3"
         style="background-color: rgba(14, 17, 23, 0.98); backdrop-filter: blur(10px);">
        <div class="scanner-container mb-5">
            <div class="scanner-line"></div>
            <span class="vault-icon-lg">üìÑ</span>
        </div>
        <h3 class="fw-bold mb-2">Analyzing Document</h3>
        <p class="text-info" id="overlay-status">Initializing secure environment...</p>
        <div class="progress w-25 mt-3" style="height: 4px; background-color: #2d3748;">
            <div id="loading-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%; transition: width 0.5s ease;"></div>
        </div>
    </div>

    <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center" style="background-color: #161b22;">
        <div>
            <h6 class="mb-0 fw-bold">Secure Chat Interface</h6>
            <small class="text-muted" id="status-indicator">Initializing...</small>
        </div>
        <span class="offline-badge">
            <span class="pulse-dot"></span> Secure Connection
        </span>
    </div>

    <div id="chat-container" class="flex-1 overflow-auto p-4" style="background-color: #0E1117; height: calc(100vh - 140px);">
        <div id="streaming-message" class="message mb-3 d-none">
            <div class="d-inline-block p-3 rounded-3 bg-dark border border-secondary text-light message-bubble ai-bubble" style="max-width: 85%;">
                <div id="stream-content"></div>
                <div id="stream-sources" class="mt-2 pt-2 border-top border-secondary small text-muted"></div>
            </div>
        </div>
    </div>

    <div class="p-3 border-top border-secondary" style="background-color: #161b22;">
        <form id="chat-form" class="d-flex gap-2">
            <input type="text" id="message-input" class="form-control bg-dark text-light border-secondary"
                   placeholder="Wait for processing to finish..." autocomplete="off" disabled>
            <button type="submit" class="btn btn-success fw-bold" id="send-btn" disabled>Send</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // Pass file info to JS
    window.currentFile = {
        type: '{{ current_file.type }}',
        name: '{{ current_file.name }}'
    };
</script>
{% endblock %}